\documentclass{beamer}

\input{settings.tex}


\title{Inverse Dynamics}
\subtitle{Contact-aware Control, Lecture 4}
\author{by Sergei Savin}
\centering
\date{\mydate}



\begin{document}
\maketitle


\begin{frame}{Content}

\begin{itemize}
\item Forward and inverse dynamics
\item Trajectory and inverse dynamics
\item Inverse dynamics with Schur projector
\item Inverse dynamics with arbitrary projector
\item Weighted pseudoinverse
\item Inverse dynamics with QP
\end{itemize}

\end{frame}




\begin{frame}{Forward and inverse dynamics}
	% \framesubtitle{Parameter estimation}
	\begin{flushleft}
		
		Let us consider a second-order dynamical system $\ddot{\bo{q}} = \mathcal{G}(\bo{q}, \dot{\bo{q}}, \bo{u})$ with state variables $(\bo{q}, \dot{\bo{q}})$ (position, velocity), highest order derivative $\ddot{\bo{q}}$ and control input $\bo{u}$.
		
		\bigskip
		
		\begin{block}{Forward Dynamics}
			Forward Dynamics for a system $\mathcal{G}$ is a problem of finding the highest order derivative $\ddot{\bo{q}}$ given state $(\bo{q}, \dot{\bo{q}})$ and control input $\bo{u}$.
		\end{block} 
		
		\bigskip
		
		\begin{block}{Inverse Dynamics}
			Inverse Dynamics for a system $\mathcal{G}$ is a problem of finding control input $\bo{u}$ given state $(\bo{q}, \dot{\bo{q}})$ and the desired value of the highest order derivative $\ddot{\bo{q}}$.
		\end{block} 
	
	\end{flushleft}
\end{frame}



\begin{frame}{Trajectory and inverse dynamics}
	% \framesubtitle{Parameter estimation}
	\begin{flushleft}
		
		Let $\bo{q}^*=\bo{q}^*(t)$ be a trajectory for a system $\mathcal{G}$ - meaning that we can substitute it to the equations describing $\mathcal{G}$ and find control law $\bo{u}^*=\bo{u}^*(t)$ that would turn them into equalities. 
		
		\bigskip
		
		Such trajectory $\bo{q}^*=\bo{q}^*(t)$ can be called a \emph{nominal trajectory} and such control law $\bo{u}^*=\bo{u}^*(t)$ can be called a \emph{nominal control law}.
		
		\bigskip
		
		A given point of time $t = t_1$ has a corresponding point on the trajectory $(\bo{q}_1^*, \dot{\bo{q}}_1^*)$, where $\bo{q}_1^*=\bo{q}^*(t_1)$, and $ \dot{\bo{q}}_1^*= \dot{\bo{q}}^*(t_1)$. It also has a corresponding acceleration $ \ddot{\bo{q}}_1^*= \ddot{\bo{q}}^*(t_1)$. In this case, the Inverse Dynamics problem is equivalent to finding the current value of the nominal control law $\bo{u}_1^*=\bo{u}^*(t_1)$.
		
	\end{flushleft}
\end{frame}



\begin{frame}{Inverse dynamics - with and w/o constraints}
	% \framesubtitle{Parameter estimation}
	\begin{flushleft}
		
		Everything we said so far about dynamical systems is true both for systems with and without explicit constraints.
		
		\bigskip
		
		This is so because, as we saw previously it is possible to transform DAE into ODEs, excluding algebraic variables.
		
	\end{flushleft}
\end{frame}



%\begin{frame}{Inverse dynamics - constrained systems}
%	% \framesubtitle{Parameter estimation}
%	\begin{flushleft}
%		
%		Given a system $\mathcal{G}$ with $n$ generalized coordinates, $m$ control inputs and $k$ independent constraints, we can observe the following three scenarios regarding its inverse dynamics:
%		
%		\begin{enumerate}
%			\item The system can be underactuated. This usually happens when $n > m+k$, but more generally it means that for a state $(\bo{q}, \dot{\bo{q}})$ there exit accelerations that the system cannot produce. We can expect Inverse Dynamics (ID) to have no solution, or one solution only.
%			
%			\item  The system is fully-actuated. This usually happens when $n = m+k$. We can expect ID to have one and only one solution.
%			
%			\item The system is over-actuated (overconstrained, redundant). This usually happens when $n < m+k$, but more generally it means that for a state $(\bo{q}, \dot{\bo{q}})$ there exit more than one $\bo{u}$ that achieve the desired acceleration.  We can expect ID to have infinitely many solutions, dimensions of the solution space is often equal to $m+k-n$.
%		\end{enumerate}
%		
%	\end{flushleft}
%\end{frame}



\begin{frame}{Inverse dynamics with Schur projector, 1}
	% \framesubtitle{Parameter estimation}
	\begin{flushleft}
		
In the last lecture we saw that the dynamics of a constrained system can be written as: 
%
\begin{align}
	\bo{P}_S(\bo{H}\ddot{\bo{q}}+\bo{h})=0
\end{align}
%
where $\bo{P}_S = 
\bo{I}-\bo{J}\T ( \bo{J} \bo{H}^{-1} \bo{J}\T )^{-1} \bo{J} \bo{H}^{-1}$.

\bigskip

let us assume that $\bo{h} = \bo{C}\dot{\bo{q}} + \bo{g} - \bo{T}\bo{u}$, where $\bo{u}$ are is a vector of motor torques, $\bo{T}$ is the control map and $\bo{T}\bo{u}$ are generalized forces generated by motor torques:
%
\begin{align}
	\bo{P}_S(\bo{H}\ddot{\bo{q}} + \bo{C}\dot{\bo{q}}+ \bo{g}) = \bo{P}_S\bo{T}\bo{u}
\end{align}
		
		
	\end{flushleft}
\end{frame}



\begin{frame}{Inverse dynamics with Schur projector, 2}
	% \framesubtitle{Parameter estimation}
	\begin{flushleft}
		
		Given dynamics in the form $\bo{P}_S(\bo{H}\ddot{\bo{q}}^* + \bo{C}\dot{\bo{q}}+ \bo{g}) = \bo{P}_S\bo{T}\bo{u}$, where $\ddot{\bo{q}}^*$ is the desired acceleration, we can find a least-square solution it for $\bo{u}$ using pseudo-inverse:
		
		\begin{align}
			\bo{u}
			=
			(\bo{P}_S\bo{T})^+\bo{P}_S(\bo{H}\ddot{\bo{q}}^* + \bo{C}\dot{\bo{q}}+ \bo{g})
		\end{align}
		
		
	\end{flushleft}
\end{frame}



\begin{frame}{Inverse dynamics with Schur projector, 3}
	% \framesubtitle{Parameter estimation}
	\begin{flushleft}
		
		Substituting expression for  $\bo{u}$ into the original dynamics, we get:
		
		Given dynamics in the form $\bo{P}_S(\bo{H}\ddot{\bo{q}}^* + \bo{C}\dot{\bo{q}}+ \bo{g}) = \bo{P}_S\bo{T}\bo{u}$, where $\ddot{\bo{q}}^*$ is the desired acceleration, we can find a least-square solution it for $\bo{u}$ using pseudo-inverse:
		
		\begin{align}
			\bo{P}_S(\bo{H}\ddot{\bo{q}}^* + \bo{C}\dot{\bo{q}}+ \bo{g}) = \bo{P}_S\bo{T}(\bo{P}_S\bo{T})^+\bo{P}_S(\bo{H}\ddot{\bo{q}} + \bo{C}\dot{\bo{q}}+ \bo{g})
			\\
			(\bo{I}-\bo{P}_S\bo{T}(\bo{P}_S\bo{T})^+)\bo{P}_S(\bo{H}\ddot{\bo{q}}^* + \bo{C}\dot{\bo{q}}+ \bo{g}) = 0
		\end{align}
		
		As we can see, the equality will hold iff $\bo{P}_S(\bo{H}\ddot{\bo{q}}^* + \bo{C}\dot{\bo{q}}+ \bo{g})$ lies in the column space of the matrix $(\bo{P}_S\bo{T})$.
		
		\bigskip
		
		If the equality above does not hold, we call such acceleration $\ddot{\bo{q}}^*$ not achievable.
		
	\end{flushleft}
\end{frame}



\begin{frame}{Inverse dynamics with arbitrary projector}
	% \framesubtitle{Parameter estimation}
	\begin{flushleft}
		
		Given two different projectors $\bo{P}_1$ and $\bo{P}_2$ describing the same constrained dynamics:
		
		\begin{align}
			\bo{P}_1(\bo{H}\ddot{\bo{q}} + \bo{C}\dot{\bo{q}}+ \bo{g}) = \bo{P}_1\bo{T}\bo{u}
			\\
			\bo{P}_2(\bo{H}\ddot{\bo{q}} + \bo{C}\dot{\bo{q}}+ \bo{g}) = \bo{P}_2\bo{T}\bo{u}
		\end{align}		
		
		the following holds:
		%
		\begin{align}
			(\bo{P}_1\bo{T})^+\bo{P}_1(\bo{H}\ddot{\bo{q}}^* + \bo{C}\dot{\bo{q}}+ \bo{g})
			=
			(\bo{P}_2\bo{T})^+\bo{P}_2(\bo{H}\ddot{\bo{q}}^* + \bo{C}\dot{\bo{q}}+ \bo{g})
		\end{align}		
		
		\bigskip
		
		Proof in \bref{https://drive.google.com/file/d/17lnZGk7TSr0wB47yHZYVzbWgN5kDS0RG/view}{Inverse Dynamics Control of Floating-Base Robots with External
			Constraints: a Unified View.}
		
	\end{flushleft}
\end{frame}




\begin{frame}{Weighted pseudoinverse, 1}
	% \framesubtitle{Parameter estimation}
	\begin{flushleft}
		
		Consider a weighted pseudoinverse problem:
		%
		\begin{align}
			\text{minimize} \ \ ||\bo{A}\bo{x}-\bo{b}||_\bo{W}
		\end{align}		
	%
	where $||\bo{x}||_\bo{W} = \sqrt{\bo{x}\T\bo{W}\bo{x}}$ and $\bo{W} > 0$. We can re-write the problem as:
	%
	\begin{align}
		\text{minimize} \ \ (\bo{A}\bo{x}-\bo{b})\T\bo{W}^\frac{1}{2}\bo{W}^\frac{1}{2}(\bo{A}\bo{x}-\bo{b})
	\end{align}
	
	But this is the same as solving least-squares problem for equality $\bo{W}^\frac{1}{2}\bo{A}\bo{x}=\bo{W}^\frac{1}{2}\bo{b}$, which is does via Moore-Penrose pseudoinverse:
	%
	\begin{align}
		\bo{x}=(\bo{W}^\frac{1}{2}\bo{A})^+\bo{W}^\frac{1}{2}\bo{b}
	\end{align}
	
	\end{flushleft}
\end{frame}


\begin{frame}{Weighted pseudoinverse, 2}
	% \framesubtitle{Parameter estimation}
	\begin{flushleft}
		
		Consider a weighted pseudoinverse problem:
		%
\begin{equation}
	\begin{aligned}
		& \underset{\bo{x}}{\text{minimize}}
		& & \bo{x}\T \bo{W} \bo{x}, \\
		& \text{subject to}
		& & \bo{A}\bo{x}=\bo{b}
	\end{aligned}
\end{equation}
		
		We can use Lagrange multipliers to rewrite the problem as minimization of the function $L(\bo{x}, \lambda) = \bo{x}\T \bo{W} \bo{x} + \lambda\T ( \bo{A}\bo{x}-\bo{b})$; optimality conditions imply that $\frac{\partial L}{\partial  \bo{x}} = 0$ and $\frac{\partial  L}{\partial  \lambda} = \bo{A}\bo{x}-\bo{b} = 0$, so:
		%
		\begin{align}
			2\bo{x}\T \bo{W} + \lambda\T \bo{A} = 0
		\end{align}		
		
		This implies $\bo{x} = \frac{1}{2} \bo{W}^{-1} \bo{A}\T \lambda$, and since $\bo{A}\bo{x}-\bo{b} = 0$, we get:
		%
		\begin{align}
			\frac{1}{2}\bo{A}\bo{W}^{-1} \bo{A}\T \lambda= \bo{b} \\
			\lambda = 2 (\bo{A}\bo{W}^{-1} \bo{A}\T)^+ \bo{b} \\
			\bo{x} = \bo{W}^{-1} \bo{A}\T (\bo{A}\bo{W}^{-1} \bo{A}\T)^+ \bo{b}
		\end{align}		
		
		
	\end{flushleft}
\end{frame}



\begin{frame}{Weighted pseudoinverse, 3}
	% \framesubtitle{Parameter estimation}
	\begin{flushleft}
		
		We can use the two formulas for weighted pseudo-inverse to add weights to any inverse dynamics formulation presented earlier.
		
		\bigskip
		
		For example, consider a problem:
		%
		\begin{align}
			\text{minimize} \ \ ||\bo{P}_S(\bo{H}\ddot{\bo{q}}^* + \bo{C}\dot{\bo{q}}+ \bo{g}) - \bo{P}_S\bo{T}\bo{u}||_\bo{W}
		\end{align}		
		
		As we showed earlier, it is solved as:
		
		\begin{align}
			\bo{u}=(\bo{W}^\frac{1}{2}\bo{P}_S\bo{T})^+\bo{W}^\frac{1}{2}
			\bo{P}_S(\bo{H}\ddot{\bo{q}}^* + \bo{C}\dot{\bo{q}}+ \bo{g})
		\end{align}
		
		
	\end{flushleft}
\end{frame}


\begin{frame}{Inverse dynamics with QP}
	% \framesubtitle{Parameter estimation}
	\begin{flushleft}
		
		Consider dynamics written in the following form:
		%
		\begin{align}
			\begin{cases}
				\bo{H} \ddot{\bo{q}} + \bo{C} \dot{\bo{q}} + \bo{g} = \bo{T}\bo{u} + \bo{J}\T \lambda
				\\
				\bo{J} \ddot{\bo{q}} + \dot{\bo{J}} \dot{\bo{q}}= 0
			\end{cases}
		\end{align}		
	
		We can solve it directly, as a quadratic program:
		
		\begin{equation}
			\begin{aligned}
				& \underset{\bo{u}, \lambda}{\text{minimize}}
				& & \bo{u}\T \bo{u}, \\
				& \text{subject to}
				& & 
				\bo{H} \ddot{\bo{q}}^* + \bo{C} \dot{\bo{q}} + \bo{g} = \bo{T}\bo{u} + \bo{J}\T \lambda
			\end{aligned}
		\end{equation}
		
		
	\end{flushleft}
\end{frame}


\begin{frame}{Read more}
	
	\begin{itemize}
		
		\item Righetti, L., Buchli, J., Mistry, M. and Schaal, S., 2011, May. Inverse dynamics control of floating-base robots with external constraints: A unified view. In 2011 IEEE international conference on robotics and automation (pp. 1085-1090). IEEE. - \bref{https://drive.google.com/file/d/17lnZGk7TSr0wB47yHZYVzbWgN5kDS0RG/view}{Inverse Dynamics Control of Floating-Base Robots with External
			Constraints: a Unified View.}
		
		\item Mistry, M., Buchli, J. and Schaal, S., 2010, May. Inverse dynamics control of floating base systems using orthogonal decomposition. In 2010 IEEE international conference on robotics and automation (pp. 3406-3412). IEEE. - \bref{http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.212.3601&rep=rep1&type=pdf}{citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.212.3601}.
	\end{itemize}
	
\end{frame}



\myqrframe

\end{document}
